<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />

		<title>Universal SiLabs Flasher</title>

		<script src="https://cdn.jsdelivr.net/pyodide/v0.22.0/full/pyodide.js"></script>

		<style type="text/css">
			body {
				padding: 0;
				margin: 0;

				font-family: sans-serif;
			}

			main {
				display: flex;
				height: 100vh;
			}

			#controls, #debug-log {
			}

			#controls {
				z-index: 2;
				width: 60%;
				padding: 1em;

				box-shadow: 0 0 2em 0 hsl(0, 0%, 10%);

				background-color: hsl(0, 0%, 99%);
				color: hsl(0, 0%, 20%);
			}

			#debug-log {
				z-index: 1;
				width: 40%;

				font-family: monospace;

				background-color: hsl(0, 0%, 20%);
				color: hsl(0, 0%, 99%);

				overflow: auto;
			}

			#debug-log h1 {
				margin: 0;
				padding: 2em;
				background-color: hsl(0, 0%, 25%);
				box-shadow: 0px 0px 1em 0px hsl(0, 0%, 10%);
			}

			#output {
				white-space: pre;

				padding: 1em;
				padding-left: 2em;
			}
		</style>
	</head>

	<body>
		<main>
			<section id="controls">
				<h1>Universal SiLabs Flasher</h1>

				<p id="step-firmware">
					<label>Choose a firmware image: <input type="file" id="choose-firmware-file" /></label>
				</p>

				<p id="step-port">
					<label>Select a serial port: <button id="select-serial-port">Select</button></label>
				</p>

				<p id="step-upload">
					<label>Upload the firmware <button id="upload-firmware">Upload</button></label>
				</p>

				<p>
					<label>Upload progress: <progress id="upload-progress" value="0" max="100"></progress></label>
				</p>

			</section>

			<section id="debug-log">
				<h1>Debug Log</h1>

				<pre id="output"></pre>
			</section>
		</main>

		<script>
			async function download_module(pyodide, module_name, path) {
				console.debug("Downloading module", module_name, "from", path);

				const contents = await (await fetch(path)).text();

				pyodide.FS.mkdir("modules");
				pyodide.FS.writeFile(`modules/${module_name}.py`, contents, {encoding: "utf8"});
			}

			async function setup_python() {
				const pyodide = await window.loadPyodide();

				await pyodide.loadPackage("micropip");
				const micropip = pyodide.pyimport("micropip");

				// Install dependencies
				await micropip.install([
					// All `aio-libs` packages have been compiled as pure-Python modules
					"./multidict-4.7.6-py3-none-any.whl",
					"./yarl-1.8.1-py3-none-any.whl",
					"./frozenlist-1.3.1-py3-none-any.whl",
					"./aiosignal-1.2.0-py3-none-any.whl",
					"./aiohttp-3.8.3-py3-none-any.whl",
					// This one also did not seem to have a wheel despite being pure-Python
					"./pure_pcapy3-1.0.1-py3-none-any.whl",
					// Finally, install the main module
					"./universal_silabs_flasher-0.0.8-py3-none-any.whl",
				]);

				// Prepare the Python path for external modules
				pyodide.runPython(`
					import sys
					sys.path.insert(0, "./modules/")
				`);

				// Download our webserial transport
				await download_module(pyodide, "webserial_transport", "./webserial_transport.py");

				// And run it
				pyodide.runPython(`
					import webserial_transport
					webserial_transport.patch_pyserial()
				`)

				return pyodide;
			}

			function async_read_file(file) {
				return new Promise(function(resolve, reject) {
					const reader = new FileReader();

					reader.onload = function() {
						resolve(reader.result);
					}

					reader.onerror = function(e) {
						reject(e);
					}

					reader.readAsArrayBuffer(file);
				});
			}

			async function main() {
				const pyodide = await setup_python();
				window.pyodide = pyodide;

				console.log("Environment is set up!");

				document.querySelector("#choose-firmware-file").addEventListener("change", async function(event) {
					const file = event.target.files[0];
					const contents = await async_read_file(file);

					const GBLImage = pyodide.pyimport("universal_silabs_flasher.flasher").GBLImage;
					const image = GBLImage.from_bytes(pyodide.toPy(contents));

					console.log("Parsed image metadata", image.get_nabucasa_metadata().toString());
				}, false);
			}

			main();

			/*
			import asyncio

			async def main():
			    # Get the firmware image
			    firmware_data = await wait_file_upload("#choose-firmware-file")
			    print(f"Read {len(firmware_data)} bytes")


			    # Get the serial port
			    import webserial_transport
			    webserial_transport.SERIAL_PORT = await prompt_serial_port("#select-serial-port")


			    import js

			    progress = js.document.querySelector("#upload-progress")

			    # Create the progress callback
			    def progress_callback(current, total):
			        progress.value = 100.0 * current / total
			        progress.textContent = f"{current / total:0.4f}%"

			    import coloredlogs
			    from universal_silabs_flasher.flasher import Flasher, GBLImage
			    coloredlogs.install(
			        fmt="%(asctime)s.%(msecs)03d %(levelname)s %(message)s",
			        level="DEBUG",
			    )

			    gbl_image = GBLImage.from_bytes(firmware_data)

			    flasher = Flasher(
			        bootloader_baudrate=115200,
			        app_baudrate=115200,
			        device="/dev/ttyUSB0",
			    )

			    await flasher.probe_app_type()
			    await flasher.enter_bootloader()
			    await flasher.flash_firmware(gbl_image, progress_callback=progress_callback)

			asyncio.create_task(main())
			*/
		</script>
	</body>
</html>