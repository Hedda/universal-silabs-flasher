<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />

		<title>Universal SiLabs Flasher</title>

		<script defer src="https://pyscript.net/latest/pyscript.js"></script>
		<py-config>
			paths = [
				"./install_dependencies.py",
				"./webserial_transport.py",
			]
		</py-config>

		<style type="text/css">
			div[id^="py-"] {
				font-family: monospace;
				white-space: pre;
			}
		</style>
	</head>

	<body>
		<h1>Universal SiLabs Flasher</h1>

		<p>
			<label for="choose-firmware-file">Choose a firmware image:</label><input type="file" id="choose-firmware-file" />
		</p>

		<p>
			<button id="select-serial-port">Select a serial port</button>
		</p>

		<p>
			<button id="upload-firmware">Upload</button>
		</p>

		<pre id="output"></pre>

		<py-script>
			from install_dependencies import install
			await install()


			from webserial_transport import wait_file_upload, prompt_serial_port, patch_pyserial
			patch_pyserial()

			# Patch yarl to be no-op
			import yarl
			
			def URL(url=None):
			    class output:
			        scheme = None

			    return output

			yarl.URL = URL


			# Get the firmware image
			firmware_data = await wait_file_upload("#choose-firmware-file")
			print(f"Read {len(firmware_data)} bytes")


			# Get the serial port
			import webserial_transport
			webserial_transport.SERIAL_PORT = await prompt_serial_port("#select-serial-port")



			import coloredlogs
			from universal_silabs_flasher.flasher import Flasher, GBLImage
			coloredlogs.install(level="DEBUG")

			gbl_image = GBLImage.from_bytes(firmware_data)

			flasher = Flasher(
			    bootloader_baudrate=115200,
			    app_baudrate=115200,
			    device="/dev/ttyUSB0",
			)

			await flasher.probe_app_type()
			await flasher.enter_bootloader()
			await flasher.flash_firmware(gbl_image)
		</py-script>
	</body>
</html>